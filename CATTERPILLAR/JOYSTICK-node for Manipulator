

//-------------------------------------------------------------------joystick_node for manipulator-------------------------------------------------------------------------





#include "rclcpp/rclcpp.hpp"
#include "std_msgs/msg/int16.hpp"
#include "sensor_msgs/msg/joy.hpp"
#include <memory>

class JoyControl : public rclcpp::Node {
public:
    JoyControl() : Node("joy_control") {
        joy_subscriber_ = this->create_subscription<sensor_msgs::msg::Joy>(
            "/joy", 10, std::bind(&JoyControl::joyCallback, this, std::placeholders::_1));

        // Publishers for L1/L2/Base and Bevel/Lift ESP32 nodes
        manipulator_pub_ = this->create_publisher<std_msgs::msg::Int16>("/manipulator_cmd", 10);  // L1/L2/Base
        bevel_pub_ = this->create_publisher<std_msgs::msg::Int16>("/bevel_cmd", 10);            // Bevel/Lift
    }

    void joyCallback(const sensor_msgs::msg::Joy::SharedPtr msg) {
        std_msgs::msg::Int16 manipulator_msg;
        std_msgs::msg::Int16 bevel_msg;

        uint16_t manipulator_cmd = 0; // bitmask for L1/L2/Base
        uint8_t bevel_cmd = 0;        // bitmask for Bevel/Lift

        const float DEADZONE = 0.2; // joystick deadzone

        // --- L1/L2/Base ---
        if (msg->axes[1] > DEADZONE) manipulator_cmd |= (1 << 0);    // L1 +
        if (msg->axes[1] < -DEADZONE) manipulator_cmd |= (1 << 1);   // L1 -
        if (msg->axes[3] > DEADZONE) manipulator_cmd |= (1 << 2);    // L2 +
        if (msg->axes[3] < -DEADZONE) manipulator_cmd |= (1 << 3);   // L2 -
        if (msg->axes[0] > DEADZONE) manipulator_cmd |= (1 << 4);    // Base +
        if (msg->axes[0] < -DEADZONE) manipulator_cmd |= (1 << 5);   // Base -

        // --- Bevel/Lift ---
        if (msg->axes[7] > DEADZONE) bevel_cmd |= (1 << 0);  // Bevel +
        if (msg->axes[7] < -DEADZONE) bevel_cmd |= (1 << 1); // Bevel -
        if (msg->axes[6] > DEADZONE) bevel_cmd |= (1 << 2);  // Lift Up
        if (msg->axes[6] < -DEADZONE) bevel_cmd |= (1 << 3); // Lift Down

        manipulator_msg.data = manipulator_cmd;
        bevel_msg.data = bevel_cmd;

        manipulator_pub_->publish(manipulator_msg);
        bevel_pub_->publish(bevel_msg);

        RCLCPP_INFO(this->get_logger(),
                    "L1L2/Base: 0x%02X | Bevel/Lift: 0x%02X",
                    manipulator_cmd, bevel_cmd);
    }

private:
    rclcpp::Subscription<sensor_msgs::msg::Joy>::SharedPtr joy_subscriber_;
    rclcpp::Publisher<std_msgs::msg::Int16>::SharedPtr manipulator_pub_;
    rclcpp::Publisher<std_msgs::msg::Int16>::SharedPtr bevel_pub_;
};

int main(int argc, char **argv) {
    rclcpp::init(argc, argv);
    auto node = std::make_shared<JoyControl>();
    RCLCPP_INFO(node->get_logger(), "Joystick control node initialized.");
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
